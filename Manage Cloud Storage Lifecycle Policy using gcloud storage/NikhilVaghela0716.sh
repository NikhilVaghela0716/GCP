#!/bin/bash

PROJECT_ID="$(gcloud config get-value project)"

BUCKET_NAME="gs://${PROJECT_ID}-bucket"
LIFECYCLE_FILE="gcs_lifecycle_rules.json"

echo "Bucket Name : $BUCKET_NAME"

cat > "$LIFECYCLE_FILE" <<'JSON'
{
  "rule": [
    {
      "action": {
        "type": "SetStorageClass",
        "storageClass": "NEARLINE"
      },
      "condition": {
        "daysSinceNoncurrentTime": 30,
        "matchesPrefix": ["projects/active/"]
      }
    },
    {
      "action": {
        "type": "SetStorageClass",
        "storageClass": "NEARLINE"
      },
      "condition": {
        "daysSinceNoncurrentTime": 90,
        "matchesPrefix": ["archive/"]
      }
    },
    {
      "action": {
        "type": "SetStorageClass",
        "storageClass": "COLDLINE"
      },
      "condition": {
        "daysSinceNoncurrentTime": 180,
        "matchesPrefix": ["archive/"]
      }
    },
    {
      "action": {
        "type": "Delete"
      },
      "condition": {
        "age": 7,
        "matchesPrefix": ["processing/temp_logs/"]
      }
    }
  ]
}
JSON

gsutil lifecycle set "$LIFECYCLE_FILE" "$BUCKET_NAME"

echo "Done"
